<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <h3>üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userNameDisplay">...</span></h3>
        <button onclick="logout()" class="danger" style="width:auto; padding: 8px 15px; font-size:14px;">
            <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å
        </button>
    </div>

    <div class="menu-grid">
        <button onclick="showSection('activityList')"><i class="fas fa-edit"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
        <button onclick="showSection('historyList')" class="secondary"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</button>
        <button onclick="showSection('settings')" class="secondary"><i class="fas fa-cog"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>

    <div id="activityList">
        <div class="card">
            <h3>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤</h3>
            <div class="form-group">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                <input type="text" id="actUserName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div class="form-group">
                <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                <input type="text" id="actName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
                <input type="text" id="actPlace" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" style="margin-top: 5px;">
            </div>
            <div class="form-row">
                <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label><input type="date" id="actDate"></div>
                <div class="form-group"><label>‡πÄ‡∏ß‡∏•‡∏≤:</label><input type="time" id="actTime"></div>
                <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á:</label><input type="number" id="actHours" placeholder="‡∏ä‡∏°." step="0.5" min="0"></div>
            </div>
            <div class="form-group">
                <label>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</label>
                <input type="text" id="actPerson" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö/‡∏ú‡∏π‡πâ‡πÄ‡∏ã‡πá‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á">
            </div>
            <div class="form-group">
                <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                <input type="file" id="actImage" accept="image/*" style="padding:10px; background:#fff;">
            </div>
            <button id="btnSubmitActivity" onclick="submitActivity()"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>

    <div id="historyList" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap: wrap; gap: 10px;">
                <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                <div style="display:flex; gap:5px;">
                    <button onclick="exportTablePDF()" style="width:auto; background:#27ae60; padding:8px 12px; font-size:14px;">
                        <i class="fas fa-table"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ß‡∏°
                    </button>
                    <button onclick="printTotalCertificate()" style="width:auto; background:#e67e22; padding:8px 12px; font-size:14px;">
                        <i class="fas fa-award"></i> ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                    </button>
                </div>
            </div>
            <div id="historyLoading" class="text-center" style="padding:20px; color:#aaa;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <table id="logsTable">
                <thead>
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th> <th>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th> <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th> <th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th> <th>‡∏ä‡∏°.</th> <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th> <th>‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="settings" class="hidden">
        <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
        <div class="card">
            <h4>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h4>
            <input type="text" id="editName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            <button onclick="updateProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
        </div>
        <div class="card">
            <h4>üìß ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h4>
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="notifyEmail" style="width:20px; height:20px; margin:0;">
                <label for="notifyEmail" style="margin:0; cursor:pointer;">‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
            </div>
            <br>
            <button class="secondary" onclick="savePreferences()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        </div>
        
        <div class="card">
            <h4>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h4>
            <input type="password" id="oldPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°" style="margin-bottom: 10px;">
            <input type="password" id="newPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (6+ ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)">
            <button class="danger" onclick="changePassword()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
        </div>

        <div class="card">
            <h4>üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</h4>
            <div style="display:flex; gap:10px;">
                <button class="secondary" onclick="contactAdmin('line')">Line</button>
                <button class="secondary" onclick="contactAdmin('email')">Email</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API URL ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwo957Zbpom3vrp_fNY5sj9-mDBvsroDN80vuZRvRsdEa_ahF_Zw0cTX55mZOXTi48a/exec";
    const UPLOAD_URL = API_URL;

    let currentUser = null;
    let activitiesDataMap = {};
    let userData = null;
    let activitiesData = [];

    window.onload = function() {
        const session = getSession();
        if (!session) {
            window.location.href = "index.html";
            return;
        }
        currentUser = session.user;
        loadUserData();
    };

    function getSession() {
        const sessionStr = localStorage.getItem('volunteerSession');
        if (!sessionStr) return null;
        try {
            const session = JSON.parse(sessionStr);
            const now = new Date().getTime();
            if ((now - session.timestamp) > (24 * 60 * 60 * 1000)) {
                localStorage.removeItem('volunteerSession');
                return null;
            }
            return session;
        } catch (e) {
            localStorage.removeItem('volunteerSession');
            return null;
        }
    }

    function saveSession(user) {
        localStorage.setItem('volunteerSession', JSON.stringify({ user: user, timestamp: new Date().getTime() }));
    }

    async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function loadUserData() {
        try {
            const response = await fetch(`${API_URL}?action=getUser&uid=${currentUser.uid}`);
            const result = await response.json();
            if (result.status === 'success') {
                userData = result.user;
                currentUser = result.user;
                saveSession(result.user);
                
                document.getElementById('userNameDisplay').innerText = userData.name || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
                document.getElementById('editName').value = userData.name || "";
                document.getElementById('actUserName').value = userData.name || "";
                document.getElementById('notifyEmail').checked = userData.emailNotify !== false;
            }
            // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User
            loadHistory();
        } catch (error) {
            console.error('Error loading user:', error);
        }
    }

    function formatDateThai(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return dateStr;
        // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö: 31 ‡∏ò.‡∏Ñ. 2568
        return date.toLocaleDateString('th-TH', { day: 'numeric', month: 'short', year: 'numeric' });
    }

    function formatTimeDisplay(timeStr) {
        if (!timeStr) return '';
        if (timeStr.includes('T') || timeStr.includes('GMT')) {
            const date = new Date(timeStr);
            if (!isNaN(date.getTime())) {
                return date.toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
            }
        }
        return timeStr.substring(0, 5);
    }

    // ==========================================
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ã‡πâ‡∏≥‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ)
    // ==========================================
    async function loadHistory() {
        const tbody = document.getElementById('tableBody');
        const loading = document.getElementById('historyLoading');
        
        // 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡∏≠‡∏á‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ!
        tbody.innerHTML = "";
        loading.classList.remove('hidden');
        
        try {
            const response = await fetch(`${API_URL}?action=getActivities&userId=${currentUser.uid}`);
            const result = await response.json();
            
            loading.classList.add('hidden');
            
            if (result.status === 'success') {
                activitiesData = result.activities;
                activitiesDataMap = {};
                
                if (activitiesData.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='7' class='text-center'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>";
                    updateLocalHoursDisplay(0, 0, 0);
                    return;
                }
                
                activitiesData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let totalHours = 0, approvedHours = 0, pendingHours = 0;
                
                // 2. ‡πÉ‡∏ä‡πâ Set ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥ ID ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß (‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡πâ‡∏• 100%)
                const seenIds = new Set();
                let htmlBuffer = ""; // ‡πÄ‡∏Å‡πá‡∏ö HTML ‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô ‡∏Ñ‡πà‡∏≠‡∏¢‡∏û‡πà‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß

                activitiesData.forEach(d => {
                    // *** ‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ñ‡πâ‡∏≤ ID ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡πÅ‡∏•‡πâ‡∏ß ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏•‡∏¢ ***
                    if (seenIds.has(d.id)) return;
                    seenIds.add(d.id);

                    activitiesDataMap[d.id] = d;
                    
                    const badgeClass = d.status === 'approved' ? 'badge-approved' : 'badge-pending';
                    const statusText = d.status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                    const hours = parseFloat(d.hours) || 0;
                    
                    totalHours += hours;
                    if (d.status === 'approved') approvedHours += hours;
                    else pendingHours += hours;
                    
                    const downloadBtn = d.status === 'approved' 
                        ? `<button onclick="printSingleActivityWrapper('${d.id}')" style="background:#3498db; padding:5px 10px; border-radius:5px;"><i class="fas fa-print"></i></button>` 
                        : `<span style="color:#ccc;">-</span>`;

                    const displayDate = formatDateThai(d.date);
                    const displayTime = formatTimeDisplay(d.time);

                    htmlBuffer += `
                        <tr>
                            <td data-label="‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤">${displayDate} <small style="color:#666; display:block;">${displayTime}</small></td>
                            <td data-label="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">${d.activityName || '-'}</td>
                            <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">${d.place || '-'}</td>
                            <td data-label="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">${d.personInCharge || '-'}</td>
                            <td data-label="‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á"><strong>${hours}</strong></td>
                            <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" style="text-align:center;"><span class="status-badge ${badgeClass}">${statusText}</span></td>
                            <td data-label="‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á" style="text-align:center;">${downloadBtn}</td>
                        </tr>`;
                });
                
                // 3. ‡πÅ‡∏õ‡∏∞ HTML ‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏ï‡∏π‡∏°‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
                tbody.innerHTML = htmlBuffer;
                
                updateLocalHoursDisplay(totalHours, approvedHours, pendingHours);
                updateUserHours(totalHours, approvedHours, pendingHours);
            }
        } catch (error) {
            console.error('Error loading activities:', error);
            loading.classList.add('hidden');
            tbody.innerHTML = "<tr><td colspan='7' class='text-center' style='color:red;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>";
        }
    }

    function updateLocalHoursDisplay(total, approved, pending) {
        if (userData) {
            userData.totalHours = total;
            userData.approvedHours = approved;
            userData.pendingHours = pending;
        }
    }

    async function updateUserHours(total, approved, pending) {
        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({ action: 'updateUser', uid: currentUser.uid, totalHours: total, approvedHours: approved, pendingHours: pending })
            });
        } catch (e) {}
    }

    function showSection(id) {
        ['activityList', 'historyList', 'settings'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if (id === 'historyList') loadHistory();
    }

    async function submitActivity() {
        const userName = document.getElementById('actUserName').value.trim();
        const name = document.getElementById('actName').value.trim();
        const place = document.getElementById('actPlace').value.trim();
        const date = document.getElementById('actDate').value;
        const time = document.getElementById('actTime').value;
        const hours = parseFloat(document.getElementById('actHours').value);
        const person = document.getElementById('actPerson').value.trim();
        const file = document.getElementById('actImage').files[0];

        if (!userName || !name || !date || !time || !hours || !file) {
            return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ', 'warning');
        }
        
        const btn = document.getElementById('btnSubmitActivity');
        const oldText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async function() {
            try {
                const base64Data = reader.result.split(',')[1];
                
                const uploadRes = await fetch(UPLOAD_URL, {
                    method: 'POST',
                    body: JSON.stringify({ base64: base64Data, mimeType: file.type, filename: `${currentUser.uid}_${Date.now()}` })
                });
                const uploadResult = await uploadRes.json();
                if (uploadResult.status !== "success") throw new Error("Upload Failed");

                const actRes = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'createActivity', userId: currentUser.uid, userName: userName, studentId: userData?.studentId || '',
                        activityName: name, place: place, date: date, time: time, hours: hours, personInCharge: person,
                        imageUrl: uploadResult.url, status: 'pending'
                    })
                });
                const actResult = await actRes.json();
                
                if (actResult.status === 'success') {
                    if (actResult.message === 'Activity already exists') {
                         Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß', 'info');
                    } else {
                         Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    }
                    document.getElementById('actName').value = '';
                    document.getElementById('actPlace').value = '';
                    document.getElementById('actHours').value = '';
                    document.getElementById('actImage').value = '';
                    showSection('historyList');
                } else {
                    throw new Error(actResult.message || 'Error saving activity');
                }
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = oldText;
            }
        };
    }

    async function updateProfile() {
        const name = document.getElementById('editName').value.trim();
        if(!name) return;
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateUser', uid: currentUser.uid, name: name }) });
            if ((await res.json()).status === 'success') {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'success');
                currentUser.name = name;
                saveSession(currentUser);
                loadUserData();
            }
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }

    async function savePreferences() {
        const emailNotify = document.getElementById('notifyEmail').checked;
        try {
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateUser', uid: currentUser.uid, emailNotify: emailNotify }) });
            if ((await res.json()).status === 'success') Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }

    async function changePassword() {
        const oldPass = document.getElementById('oldPassword').value;
        const newPass = document.getElementById('newPassword').value;
        if (!oldPass || !newPass || newPass.length < 6) return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö (‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á 6 ‡∏ï‡∏±‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ)', 'warning');

        try {
            const oldPassHash = await hashPassword(oldPass);
            const newPassHash = await hashPassword(newPass);
            const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'changePassword', uid: currentUser.uid, oldPasswordHash: oldPassHash, newPasswordHash: newPassHash }) });
            if ((await res.json()).status === 'success') {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà', 'success').then(() => logout());
            } else {
                Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        } catch (e) { Swal.fire('Error', e.message, 'error'); }
    }

    function contactAdmin(type) {
        if(type==='line') window.open('https://line.me/ti/p/~YOUR_LINE_ID', '_blank');
        else window.location.href = "mailto:support@volunteer.com";
    }

    function logout() {
        localStorage.removeItem('volunteerSession');
        window.location.href = "index.html";
    }

    // ==========================================
    // PDF Generator Section
    // ==========================================
    async function loadThaiFont(doc) {
        // ‚ö†Ô∏è ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡πÄ‡∏≠‡∏≤ Base64 ‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô PDF ‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‚ö†Ô∏è
        const fontRegular = "‡πÉ‡∏™‡πà_BASE64_‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå_THSARABUN_REGULAR_‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ"; 
        const fontBold = "‡πÉ‡∏™‡πà_BASE64_‡∏Ç‡∏≠‡∏á‡∏ü‡∏≠‡∏ô‡∏ï‡πå_THSARABUN_BOLD_‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ"; 

        if (fontRegular.includes('‡πÉ‡∏™‡πà_BASE64') || fontRegular.length < 100) {
            await Swal.fire({ icon: 'error', title: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ü‡∏≠‡∏ô‡∏ï‡πå', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Base64 Font ‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö' });
            return false;
        }
        try {
            doc.addFileToVFS("THSarabun-Regular.ttf", fontRegular);
            doc.addFileToVFS("THSarabun-Bold.ttf", fontBold);
            doc.addFont("THSarabun-Regular.ttf", "THSarabun", "normal");
            doc.addFont("THSarabun-Bold.ttf", "THSarabun", "bold");
            return true;
        } catch (e) { return false; }
    }

    async function exportTablePDF() {
        if (!window.jspdf) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF({ orientation: 'landscape' });
        Swal.showLoading();
        if (!(await loadThaiFont(doc))) return;

        doc.setFont('THSarabun', 'bold');
        doc.setFontSize(22); 
        doc.text("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤", 14, 20);
        
        doc.autoTable({ 
            html: '#logsTable', startY: 25, 
            styles: { font: "THSarabun", fontSize: 12 }, 
            headStyles: { font: "THSarabun", fontStyle: 'bold', fontSize: 14, fillColor: [44, 62, 80] },
            columnStyles: { 6: { cellWidth: 0 } }, 
            didParseCell: function(data) {
                if (data.column.index === 6) data.cell.text = ''; 
            }
        });
        Swal.close();
        doc.save('activity-log.pdf');
    }

    async function printTotalCertificate() {
        const totalApprovedHours = userData?.approvedHours || 0;
        if (totalApprovedHours <= 0) return Swal.fire('‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô', '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'warning');
        
        Swal.showLoading();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        if (!(await loadThaiFont(doc))) return;

        generateCertificateLayout(doc, userData?.name || currentUser.email, "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡∏Ñ‡∏°", "‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢...", "‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", `${totalApprovedHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`);
        doc.save("‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏ß‡∏°.pdf");
        Swal.close();
    }

    function printSingleActivityWrapper(id) {
        const act = activitiesDataMap[id];
        if(act) printSingleActivity(act);
    }

    async function printSingleActivity(act) {
        Swal.showLoading();
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        if (!(await loadThaiFont(doc))) return;

        const dateStr = formatDateThai(act.date);
        generateCertificateLayout(doc, act.userName || "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°", act.activityName, act.place, dateStr, `${act.hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`);
        doc.save(`‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á_${act.activityName}.pdf`);
        Swal.close();
    }

    function generateCertificateLayout(doc, name, activityName, place, dateStr, hours) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const centerX = pageWidth / 2;
        
        doc.setFont('THSarabun', 'bold');
        doc.setFontSize(24);
        doc.text("‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á", centerX, 45, { align: "center" });
        doc.setFontSize(18);
        doc.text("‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡∏ö‡∏≥‡πÄ‡∏û‡πá‡∏ç‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏°", centerX, 55, { align: "center" });

        doc.setFont('THSarabun', 'normal');
        doc.setFontSize(14); 
        let startY = 80; const lineGap = 8; 

        doc.text(`‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏ß‡πà‡∏≤ ${name}`, centerX, startY, { align: "center" });
        startY += lineGap;
        doc.text(`‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activityName}"`, centerX, startY, { align: "center" });
        startY += lineGap;
        doc.text(`‡∏ì ${place} ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`, centerX, startY, { align: "center" });
        startY += lineGap;
        doc.text(`‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${hours}`, centerX, startY, { align: "center" });

        startY += (lineGap * 2.5); 
        const today = formatDateThai(new Date().toISOString());
        doc.text(`‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${today}`, centerX, startY, { align: "center" });

        const signY = startY + 40; const signX = 130; 
        doc.text("(.......................................................)", signX, signY, { align: "center" });
        doc.setFont('THSarabun', 'bold');
        doc.text("‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡∏•‡∏á‡∏ô‡∏≤‡∏°", signX, signY + 8, { align: "center" });
    }
</script>
</body>
</html>