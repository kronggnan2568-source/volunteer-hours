<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤</title>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>

<div class="container">
    <div class="nav-bar">
        <h3>üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userNameDisplay">...</span></h3>
        <button onclick="logout()" class="danger" style="width:auto; padding: 8px 15px; font-size:14px;">
            <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å
        </button>
    </div>

    <div class="menu-grid">
        <button onclick="showSection('activityList')"><i class="fas fa-edit"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
        <button onclick="showSection('historyList')" class="secondary"><i class="fas fa-history"></i> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥/‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</button>
        <button onclick="showSection('settings')" class="secondary"><i class="fas fa-cog"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
    </div>

    <div id="activityList">
        <div class="card">
            <h3>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤</h3>
            <div class="form-group">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                <input type="text" id="actUserName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            </div>
            <div class="form-group">
                <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                <input type="text" id="actName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
                <input type="text" id="actPlace" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" style="margin-top: 5px;">
            </div>
            <div class="form-row">
                <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label><input type="date" id="actDate"></div>
                <div class="form-group"><label>‡πÄ‡∏ß‡∏•‡∏≤:</label><input type="time" id="actTime"></div>
                <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á:</label><input type="number" id="actHours" placeholder="‡∏ä‡∏°." step="0.5" min="0"></div>
            </div>
            <div class="form-group">
                <label>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</label>
                <input type="text" id="actPerson" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö/‡∏ú‡∏π‡πâ‡πÄ‡∏ã‡πá‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á">
            </div>
            <div class="form-group">
                <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                <input type="file" id="actImage" accept="image/*" style="padding:10px; background:#fff;">
            </div>
            <button onclick="submitActivity()"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
        </div>
    </div>

    <div id="historyList" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap: wrap; gap: 10px;">
                <h3>üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</h3>
                <div style="display:flex; gap:5px;">
                    <button onclick="exportTablePDF()" style="width:auto; background:#27ae60; padding:8px 12px; font-size:14px;">
                        <i class="fas fa-table"></i> ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏£‡∏ß‡∏°
                    </button>
                    <button onclick="printTotalCertificate()" style="width:auto; background:#e67e22; padding:8px 12px; font-size:14px;">
                        <i class="fas fa-award"></i> ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á
                    </button>
                </div>
            </div>
            <div id="historyLoading" class="text-center" style="padding:20px; color:#aaa;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <table id="logsTable">
                <thead>
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤</th> <th>‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th> <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th> <th>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</th> <th>‡∏ä‡∏°.</th> <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th> <th>‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="settings" class="hidden">
        <h3>‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</h3>
        <div class="card">
            <h4>üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</h4>
            <input type="text" id="editName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
            <button onclick="updateProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠</button>
        </div>
        <div class="card">
            <h4>üìß ‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h4>
            <div style="display:flex; align-items:center; gap:10px;">
                <input type="checkbox" id="notifyEmail" style="width:20px; height:20px; margin:0;">
                <label for="notifyEmail" style="margin:0; cursor:pointer;">‡∏£‡∏±‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</label>
            </div>
            <br>
            <button class="secondary" onclick="savePreferences()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
        </div>
        
        <div class="card">
            <h4>üîë ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h4>
            <input type="password" id="oldPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°" style="margin-bottom: 10px;">
            <input type="password" id="newPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà (6+ ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)">
            <button class="danger" onclick="changePassword()">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
        </div>

        <div class="card">
            <h4>üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô</h4>
            <div style="display:flex; gap:10px;">
                <button class="secondary" onclick="contactAdmin('line')">Line</button>
                <button class="secondary" onclick="contactAdmin('email')">Email</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzzVff4uCKpwSofyqTBGYGn_JlV-Yt30aAsukLF29v3CsNvF3OWhbA5EHr7Bq-ldIOZ/exec";
    const UPLOAD_URL = API_URL;

    let currentUser = null;
    let activitiesDataMap = {};
    let userData = null;
    let activitiesData = [];

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session
    window.onload = function() {
        const session = getSession();
        if (!session) {
            window.location.href = "index.html";
            return;
        }
        currentUser = session.user;
        loadUserData();
    };

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Session
    function getSession() {
        const sessionStr = localStorage.getItem('volunteerSession');
        if (!sessionStr) return null;

        try {
            const session = JSON.parse(sessionStr);
            const now = new Date().getTime();
            const sessionAge = now - session.timestamp;
            const maxAge = 24 * 60 * 60 * 1000;

            if (sessionAge > maxAge) {
                localStorage.removeItem('volunteerSession');
                return null;
            }

            return session;
        } catch (e) {
            localStorage.removeItem('volunteerSession');
            return null;
        }
    }

    function saveSession(user) {
        const session = {
            user: user,
            timestamp: new Date().getTime()
        };
        localStorage.setItem('volunteerSession', JSON.stringify(session));
    }

    async function hashPassword(password) {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    async function loadUserData() {
        try {
            const response = await fetch(`${API_URL}?action=getUser&uid=${currentUser.uid}`);
            const result = await response.json();
            
            if (result.status === 'success') {
                userData = result.user;
                currentUser = result.user;
                saveSession(result.user);
                
                document.getElementById('userNameDisplay').innerText = userData.name || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
                document.getElementById('editName').value = userData.name || "";
                document.getElementById('actUserName').value = userData.name || "";
                document.getElementById('notifyEmail').checked = userData.emailNotify !== false;
            }
            
            loadHistory();
        } catch (error) {
            console.error('Error loading user:', error);
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ', 'error');
        }
    }

    async function loadHistory() {
        const tbody = document.getElementById('tableBody');
        const loading = document.getElementById('historyLoading');
        loading.classList.remove('hidden');
        tbody.innerHTML = "";
        
        try {
            const response = await fetch(`${API_URL}?action=getActivities&userId=${currentUser.uid}`);
            const result = await response.json();
            
            loading.classList.add('hidden');
            
            if (result.status === 'success') {
                activitiesData = result.activities;
                activitiesDataMap = {};
                
                if (activitiesData.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='7' class='text-center'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</td></tr>";
                    updateLocalHoursDisplay(0, 0, 0);
                    return;
                }
                
                activitiesData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                let totalHours = 0, approvedHours = 0, pendingHours = 0;
                
                activitiesData.forEach(d => {
                    activitiesDataMap[d.id] = d;
                    
                    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ span ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà class ‡∏ó‡∏µ‡πà td ---
                    const badgeClass = d.status === 'approved' ? 'badge-approved' : 'badge-pending';
                    const statusText = d.status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö';
                    
                    const hours = parseFloat(d.hours) || 0;
                    totalHours += hours;
                    if (d.status === 'approved') approvedHours += hours;
                    else pendingHours += hours;
                    
                    let downloadBtn = '';
                    if (d.status === 'approved') {
                        downloadBtn = `<button onclick="printSingleActivityWrapper('${d.id}')" style="background:#3498db; padding:10px 20px; font-size:16px; width:auto; border-radius:5px;"><i class="fas fa-print"></i></button>`;
                    } else {
                        downloadBtn = `<span style="color:#ccc;">-</span>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td data-label="‡∏ß‡∏±‡∏ô/‡πÄ‡∏ß‡∏•‡∏≤">${d.date || '-'} <small>(${d.time || '-'})</small></td>
                            <td data-label="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">${d.activityName || '-'}</td>
                            <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">${d.place || '-'}</td>
                            <td data-label="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">${d.personInCharge || '-'}</td>
                            <td data-label="‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á"><strong>${hours}</strong></td>
                            
                            <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞" style="text-align:center;">
                                <span class="status-badge ${badgeClass}">${statusText}</span>
                            </td>

                            <td data-label="‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á" style="text-align:center;">${downloadBtn}</td>
                        </tr>`;
                });
                
                updateLocalHoursDisplay(totalHours, approvedHours, pendingHours);
                updateUserHours(totalHours, approvedHours, pendingHours);
            }
        } catch (error) {
            console.error('Error loading activities:', error);
            loading.classList.add('hidden');
            tbody.innerHTML = "<tr><td colspan='7' class='text-center' style='color:red;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>";
        }
    }

    function updateLocalHoursDisplay(total, approved, pending) {
        if (userData) {
            userData.totalHours = total;
            userData.approvedHours = approved;
            userData.pendingHours = pending;
        }
    }

    async function updateUserHours(total, approved, pending) {
        try {
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'updateUser',
                    uid: currentUser.uid,
                    totalHours: total,
                    approvedHours: approved,
                    pendingHours: pending
                })
            });
        } catch (error) {
            console.error('Error updating hours:', error);
        }
    }

    function showSection(id) {
        ['activityList', 'historyList', 'settings'].forEach(s => document.getElementById(s).classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if (id === 'historyList') loadHistory();
    }

    async function submitActivity() {
        const userName = document.getElementById('actUserName').value.trim();
        const name = document.getElementById('actName').value.trim();
        const place = document.getElementById('actPlace').value.trim();
        const date = document.getElementById('actDate').value;
        const time = document.getElementById('actTime').value;
        const hours = parseFloat(document.getElementById('actHours').value);
        const person = document.getElementById('actPerson').value.trim();
        const file = document.getElementById('actImage').files[0];

        if (!userName || !name || !date || !time || !hours || !file) {
            return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ', 'warning');
        }
        
        const btn = document.querySelector('#activityList button');
        const oldText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async function() {
            try {
                const base64Data = reader.result.split(',')[1];
                
                const uploadRes = await fetch(UPLOAD_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        base64: base64Data,
                        mimeType: file.type,
                        filename: `${currentUser.uid}_${Date.now()}`
                    })
                });
                const uploadResult = await uploadRes.json();
                
                if (uploadResult.status !== "success") throw new Error("Upload Failed");

                const actRes = await fetch(API_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'createActivity',
                        userId: currentUser.uid,
                        userName: userName,
                        studentId: userData?.studentId || '',
                        activityName: name,
                        place: place,
                        date: date,
                        time: time,
                        hours: hours,
                        personInCharge: person,
                        imageUrl: uploadResult.url,
                        status: 'pending'
                    })
                });
                const actResult = await actRes.json();
                
                if (actResult.status === 'success') {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => {
                        document.getElementById('actName').value = '';
                        document.getElementById('actPlace').value = '';
                        document.getElementById('actDate').value = '';
                        document.getElementById('actTime').value = '';
                        document.getElementById('actHours').value = '';
                        document.getElementById('actPerson').value = '';
                        document.getElementById('actImage').value = '';
                        showSection('historyList');
                    });
                }
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = oldText;
            }
        };
    }

    async function updateProfile() {
        const name = document.getElementById('editName').value.trim();
        if(!name) return;
        
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'updateUser',
                    uid: currentUser.uid,
                    name: name
                })
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß', 'success');
                currentUser.name = name;
                saveSession(currentUser);
                loadUserData();
            }
        } catch (error) {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
        }
    }

    async function savePreferences() {
        const emailNotify = document.getElementById('notifyEmail').checked;
        
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'updateUser',
                    uid: currentUser.uid,
                    emailNotify: emailNotify
                })
            });
            const result = await response.json();
            
            if (result.status === 'success') {
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }
        } catch (error) {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
        }
    }

    async function changePassword() {
        const oldPass = document.getElementById('oldPassword').value;
        const newPass = document.getElementById('newPassword').value;

        if (!oldPass || !newPass) {
            return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà', 'warning');
        }
        if (newPass.length < 6) {
            return Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£', 'warning');
        }

        try {
            const oldPassHash = await hashPassword(oldPass);
            const newPassHash = await hashPassword(newPass);

            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    action: 'changePassword',
                    uid: currentUser.uid,
                    oldPasswordHash: oldPassHash,
                    newPasswordHash: newPassHash
                })
            });

            const result = await response.json();

            if (result.status === 'success') {
                Swal.fire({
                    icon: 'success',
                    title: '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà',
                    confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á'
                }).then(() => {
                    logout();
                });
            } else {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', result.message || '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            }
        } catch (error) {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', error.message, 'error');
        }
    }

    function contactAdmin(type) {
        if(type==='line') window.open('https://line.me/ti/p/~YOUR_LINE_ID', '_blank');
        else window.location.href = "mailto:support@volunteer.com";
    }

    function logout() {
        localStorage.removeItem('volunteerSession');
        window.location.href = "index.html";
    }

    // ==========================================
    // PDF Functions - ‡πÉ‡∏™‡πà‡∏ü‡∏≠‡∏ô‡∏ï‡πå Base64 ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
    // ==========================================
    
    async function loadThaiFont(doc) {
        const fontRegular = ``; // ‡πÉ‡∏™‡πà Base64 ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const fontBold = ``;    // ‡πÉ‡∏™‡πà Base64 ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ

        if (fontRegular.length < 100 || fontBold.length < 100) {
            await Swal.fire({
                icon: 'error',
                title: '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÉ‡∏™‡πà‡∏ü‡∏≠‡∏ô‡∏ï‡πå',
                text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ü‡∏•‡πå THSarabun ‡πÄ‡∏õ‡πá‡∏ô Base64 ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏≥‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö',
            });
            return false;
        }

        try {
            doc.addFileToVFS("THSarabun-Regular.ttf", fontRegular);
            doc.addFileToVFS("THSarabun-Bold.ttf", fontBold);
            doc.addFont("THSarabun-Regular.ttf", "THSarabun", "normal");
            doc.addFont("THSarabun-Bold.ttf", "THSarabun", "bold");
            return true;
        } catch (e) {
            Swal.fire('Font Error', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö Base64 ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
            return false;
        }
    }

    async function exportTablePDF() {
        try {
            if (!window.jspdf) throw new Error("‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ jsPDF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'landscape' });
            
            Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});
            
            const fontSuccess = await loadThaiFont(doc);
            if (!fontSuccess) return;

            doc.setFont('THSarabun', 'bold');
            doc.setFontSize(22); 
            doc.text("‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤", 14, 20);
            
            doc.autoTable({ 
                html: '#logsTable', 
                startY: 25, 
                theme: 'grid', 
                styles: { font: "THSarabun", fontStyle: 'normal', fontSize: 12, cellPadding: 2, lineColor: [200, 200, 200], lineWidth: 0.1, valign: 'middle', overflow: 'linebreak' }, 
                headStyles: { font: "THSarabun", fontStyle: 'bold', fontSize: 14, fillColor: [44, 62, 80], textColor: [255, 255, 255], halign: 'center' },
                bodyStyles: { textColor: [0, 0, 0] },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 40 },
                    1: { halign: 'left', cellWidth: 'auto' },
                    2: { halign: 'left', cellWidth: 'auto' },
                    3: { halign: 'left', cellWidth: 'auto' },
                    4: { halign: 'center', cellWidth: 15 },
                    5: { halign: 'center', cellWidth: 30 },
                    6: { halign: 'center', cellWidth: 20 }
                },
                columns: [ { dataKey: 0 }, { dataKey: 1 }, { dataKey: 2 }, { dataKey: 3 }, { dataKey: 4 }, { dataKey: 5 } ]
            });
            Swal.close();
            doc.save('activity-log.pdf');
        } catch (err) {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
        }
    }

    async function printTotalCertificate() {
        try {
            const totalApprovedHours = userData?.approvedHours || 0;
            const userName = userData?.name || currentUser.email;

            if (totalApprovedHours <= 0) {
                return Swal.fire('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏≠‡∏Å‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡πÑ‡∏î‡πâ', '‡∏Ñ‡∏∏‡∏ì‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', 'warning');
            }
            
            Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

            if (!window.jspdf) throw new Error("‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ jsPDF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            
            const fontSuccess = await loadThaiFont(doc);
            if (!fontSuccess) return;

            generateCertificateLayout(doc, userName, "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏á‡∏Ñ‡∏°", "‡∏°‡∏´‡∏≤‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏•‡∏±‡∏¢‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è...", "‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤", `${totalApprovedHours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`);
            doc.save("‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏£‡∏ß‡∏°‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á.pdf");
            Swal.close();
        } catch (err) {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
        }
    }

    function printSingleActivityWrapper(id) {
        printSingleActivity(id);
    }

    async function printSingleActivity(activityId) {
        try {
            const act = activitiesDataMap[activityId];
            if (!act) return;

            Swal.fire({title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á...', allowOutsideClick: false, didOpen: () => Swal.showLoading()});

            if (!window.jspdf) throw new Error("‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ jsPDF ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
            
            const fontSuccess = await loadThaiFont(doc);
            if (!fontSuccess) return;

            const d = new Date(act.date);
            const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
            const dateStr = `${d.getDate()} ${monthNames[d.getMonth()]} ${d.getFullYear() + 543}`;

            generateCertificateLayout(doc, act.userName || "‡∏ú‡∏π‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°", act.activityName, act.place, dateStr, `${act.hours} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`);
            doc.save(`‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á_${act.activityName}.pdf`);
            Swal.close();
        } catch (err) {
            Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', err.message, 'error');
        }
    }

    function generateCertificateLayout(doc, name, activityName, place, dateStr, hours) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const centerX = pageWidth / 2;
        
        doc.setFont('THSarabun', 'bold');
        doc.setFontSize(24);
        doc.text("‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á", centerX, 45, { align: "center" });

        doc.setFontSize(18);
        doc.text("‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡∏ö‡∏≥‡πÄ‡∏û‡πá‡∏ç‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏ï‡πà‡∏≠‡∏™‡∏±‡∏á‡∏Ñ‡∏°", centerX, 55, { align: "center" });

        doc.setFont('THSarabun', 'normal');
        doc.setFontSize(14); 
        
        let startY = 80;
        const lineGap = 8; 

        doc.text(`‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏â‡∏ö‡∏±‡∏ö‡∏ô‡∏µ‡πâ‡∏≠‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á‡∏ß‡πà‡∏≤ ${name}`, centerX, startY, { align: "center" });
        startY += lineGap;
        doc.text(`‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° "${activityName}"`, centerX, startY, { align: "center" });
        startY += lineGap;
        doc.text(`‡∏ì ${place} ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dateStr}`, centerX, startY, { align: "center" });
        startY += lineGap;
        doc.text(`‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${hours}`, centerX, startY, { align: "center" });

        startY += (lineGap * 2.5); 
        const today = new Date();
        const monthNames = ["‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"];
        const dateText = `‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ ‡∏ì ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${today.getDate()} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthNames[today.getMonth()]} ‡∏û.‡∏®. ${today.getFullYear() + 543}`;
        doc.text(dateText, centerX, startY, { align: "center" });

        const signY = startY + 40; 
        const signX = 130; 
        doc.text("(.......................................................)", signX, signY, { align: "center" });
        doc.setFont('THSarabun', 'bold');
        doc.text("‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤‡∏Ø", signX, signY + 8, { align: "center" });
        doc.setFont('THSarabun', 'normal');
        doc.text("‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÅ‡∏ó‡∏ô‡∏≠‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏î‡∏µ", signX, signY + 16, { align: "center" });

        const footerX = 25;
        const footerY = 240; 
        doc.setFont('THSarabun', 'normal');
        doc.setFontSize(14);
        doc.text("‡∏ú‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°", footerX, footerY);
        doc.setFont('THSarabun', 'bold');
        doc.text("‡∏ô‡∏≤‡∏¢‡∏≠‡∏≤‡∏ô‡∏±‡∏™ ‡πÄ‡∏ö‡πá‡∏Å‡∏Æ‡∏≤‡∏ß‡∏±‡∏ô", footerX, footerY + 8);
        doc.setFont('THSarabun', 'normal');
        doc.text("‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ ‡∏Å‡∏≠‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ô‡∏±‡∏Å‡∏®‡∏∂‡∏Å‡∏©‡∏≤", footerX, footerY + 16);
        doc.text("‡πÇ‡∏ó‡∏£ 064-9019989", footerX, footerY + 24);
    }
</script>
</body>
</html>