<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° - ‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@200;300;400;600&display=swap" rel="stylesheet">

    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å dashboard.html */
        body { font-family: 'Sarabun', sans-serif; font-weight: 200; }
        .btn-custom { border: none; padding: 8px 15px; font-size: 14px; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 6px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15); transition: transform 0.2s; color: white; white-space: nowrap; height: 40px; width: auto !important; margin: 0 !important; }
        .btn-green { background-color: #4CAF50 !important; }
        .btn-orange { background-color: #D9822B !important; }
        .btn-blue { background-color: #3498db !important; }
        .btn-custom:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); filter: brightness(1.1); }
        
        /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */
        .menu-grid button.active {
            background-color: #3498db; /* ‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡∏∂‡πâ‡∏ô */
            color: white;
            border: 2px solid #2980b9;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="nav-bar">
            <h3>üëã ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ, <span id="userNameDisplay">...</span></h3>
            <button onclick="logout()" class="danger" style="width:auto; padding: 8px 15px; font-size:14px;">
                <i class="fas fa-sign-out-alt"></i> ‡∏≠‡∏≠‡∏Å
            </button>
        </div>

        <div id="activityList">
            <div class="card">
                <h3>üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏¥‡∏ï‡∏≠‡∏≤‡∏™‡∏≤</h3>
                <div class="form-group">
                    <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• ‡∏ú‡∏π‡πâ‡∏ó‡∏≥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                    <input type="text" id="actUserName" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
                </div>
                <div class="form-group">
                    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                    <input type="text" id="actName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
                    <input type="text" id="actPlace" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà" style="margin-top: 5px;">
                </div>
                <div class="form-row">
                    <div class="form-group"><label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label><input type="date" id="actDate"></div>
                    <div class="form-group"><label>‡πÄ‡∏ß‡∏•‡∏≤:</label><input type="time" id="actTime"></div>
                    <div class="form-group"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á:</label><input type="number" id="actHours" placeholder="‡∏ä‡∏°." step="0.5" min="0"></div>
                </div>
                <div class="form-group">
                    <label>‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</label>
                    <input type="text" id="actPerson" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö/‡∏ú‡∏π‡πâ‡πÄ‡∏ã‡πá‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á">
                </div>
                <div class="form-group">
                    <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°:</label>
                    <input type="file" id="actImage" accept="image/*" style="padding:10px; background:#fff;">
                </div>
                <button id="btnSubmitActivity" onclick="submitActivity()"><i class="fas fa-save"></i> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwDYB9-YNqmcRyBPVi3twtY-lTD-V0kPOjSD0AsVjwljno6h8PuIrNSLvqd1PeVR23V/exec";
        const UPLOAD_URL = API_URL;
        let currentUser = null;
        let userData = null;

        window.onload = function () {
            const session = getSession();
            if (!session) {
                window.location.href = "index.html";
                return;
            }
            currentUser = session.user;
            loadUserData();
        };

        function getSession() {
            const sessionStr = localStorage.getItem('volunteerSession');
            if (!sessionStr) return null;
            try {
                const session = JSON.parse(sessionStr);
                const now = new Date().getTime();
                if ((now - session.timestamp) > (24 * 60 * 60 * 1000)) return null;
                return session;
            } catch (e) { return null; }
        }

        function saveSession(user) {
            localStorage.setItem('volunteerSession', JSON.stringify({ user: user, timestamp: new Date().getTime() }));
        }

        async function loadUserData() {
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠
                document.getElementById('userNameDisplay').innerText = currentUser.name || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
                document.getElementById('actUserName').value = currentUser.name || "";
                
                // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏±‡∏ß‡∏£‡πå (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô)
                const response = await fetch(`${API_URL}?action=getUser&uid=${currentUser.uid}`);
                const result = await response.json();
                if (result.status === 'success') {
                    userData = result.user;
                    currentUser = result.user; 
                    saveSession(result.user);
                    
                    document.getElementById('userNameDisplay').innerText = userData.name || "‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ";
                    document.getElementById('actUserName').value = userData.name || "";
                }
            } catch (error) { console.error(error); }
        }

        async function submitActivity() {
            const userName = document.getElementById('actUserName').value.trim();
            const name = document.getElementById('actName').value.trim();
            const place = document.getElementById('actPlace').value.trim();
            const date = document.getElementById('actDate').value;
            const time = document.getElementById('actTime').value;
            const hours = parseFloat(document.getElementById('actHours').value);
            const person = document.getElementById('actPerson').value.trim();
            const file = document.getElementById('actImage').files[0];

            if (!userName || !name || !date || !time || !hours || !file) {
                return Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ', 'warning');
            }

            const btn = document.getElementById('btnSubmitActivity');
            const oldText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async function () {
                try {
                    const base64Data = reader.result.split(',')[1];
                    const uploadRes = await fetch(UPLOAD_URL, {
                        method: 'POST',
                        body: JSON.stringify({ base64: base64Data, mimeType: file.type, filename: `${currentUser.uid}_${Date.now()}` })
                    });
                    const uploadResult = await uploadRes.json();
                    if (uploadResult.status !== "success") throw new Error("Upload Failed");

                    const actRes = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({
                            action: 'createActivity', userId: currentUser.uid, userName: userName, studentId: userData?.studentId || '',
                            activityName: name, place: place, date: date, time: time, hours: hours, personInCharge: person,
                            imageUrl: uploadResult.url, status: 'pending'
                        })
                    });
                    const actResult = await actRes.json();

                    if (actResult.status === 'success') {
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success').then(() => {
                            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
                            document.getElementById('actName').value = '';
                            document.getElementById('actPlace').value = '';
                            document.getElementById('actHours').value = '';
                            document.getElementById('actImage').value = '';
                            // ‡∏ñ‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÑ‡∏´‡∏°
                            Swal.fire({
                                title: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
                                text: "‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏•‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
                                icon: 'question',
                                showCancelButton: true,
                                confirmButtonText: '‡πÑ‡∏õ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥',
                                cancelButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡πà‡∏≠'
                            }).then((result) => {
                                if (result.isConfirmed) {
                                    window.location.href = 'history.html';
                                }
                            });
                        });
                    } else {
                        throw new Error(actResult.message || 'Error saving activity');
                    }
                } catch (e) {
                    Swal.fire('Error', e.message, 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = oldText;
                }
            };
        }

        function logout() {
            localStorage.removeItem('volunteerSession');
            window.location.href = "index.html";
        }
    </script>
</body>
</html>