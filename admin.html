<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Super Fast</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --border-color: #cbd5e1;
            --text-head: #1e293b;
            --text-body: #475569;
            --bg: #f1f5f9;
        }

        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text-body); }
        .container { max-width: 1200px; margin: 0 auto; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .title-group h2 { margin: 0; color: #0f172a; font-size: 24px; }
        .status-badge { display: inline-flex; align-items: center; font-size: 12px; padding: 4px 10px; border-radius: 20px; background: #e2e8f0; color: #64748b; margin-top: 5px; }
        .dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; margin-right: 6px; transition: 0.3s; }
        .dot.active { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .dot.cache { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }

        /* Card Design */
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; border: 1px solid #e2e8f0; }

        /* --- Beautiful Bordered Table --- */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        thead { background: #f8fafc; }
        th { 
            padding: 16px; 
            text-align: left; 
            font-weight: 600; 
            color: var(--text-head); 
            border: 1px solid var(--border-color);
            white-space: nowrap;
        }
        
        td { 
            padding: 14px 16px; 
            border: 1px solid var(--border-color);
            vertical-align: middle;
            white-space: nowrap; /* üî• ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏±‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î üî• */
        }

        tr:hover td { background-color: #f1f5f9; cursor: default; }

        /* Badges */
        .badge { padding: 4px 12px; border-radius: 6px; font-size: 13px; font-weight: 600; text-transform: capitalize; }
        .badge.approved { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge.rejected { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge.pending { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; }

        /* Buttons */
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: 0.2s; font-family: 'Sarabun'; display: inline-flex; align-items: center; gap: 6px; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); }
        .btn-secondary { background: white; border: 1px solid var(--border-color); color: var(--text-body); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }

        /* Action Buttons */
        .action-btn { width: 32px; height: 32px; border-radius: 6px; border: none; display: inline-flex; align-items: center; justify-content: center; margin: 0 2px; cursor: pointer; color: white; transition: 0.2s; }
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-check { background: #22c55e; }
        .btn-edit { background: #f59e0b; }
        .btn-cross { background: #ef4444; }
        .btn-trash { background: #64748b; }

        /* Loading Overlay */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: transparent; z-index: 9999; }
        #loader .bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            thead { display: none; }
            tr, td { display: block; border: none; }
            tr { border: 1px solid var(--border-color); margin-bottom: 15px; border-radius: 8px; padding: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
            td { padding: 8px 0; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px dashed #e2e8f0; }
            td:last-child { border-bottom: none; display: block; padding-top: 15px; }
            td::before { content: attr(data-label); font-weight: 600; color: #64748b; }
            .header { flex-direction: column; align-items: flex-start; }
            .header > div { display: flex; flex-wrap: wrap; gap: 5px; }
        }
    </style>
</head>
<body>

<div id="loader"><div class="bar"></div></div>

<div class="container">
    <div class="header">
        <div class="title-group">
            <h2><i class="fas fa-user-shield"></i> Admin Dashboard</h2>
            <div class="status-badge"><span class="dot" id="liveDot"></span> <span id="liveText">Connecting...</span></div>
        </div>
        <div>
            <button onclick="forceRefresh()" class="btn btn-secondary" id="btnRefresh">
                <i class="fas fa-sync" id="iconRefresh"></i> ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
            </button>
            <button onclick="manualAdd()" class="btn btn-primary"><i class="fas fa-plus"></i> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</button>
            <button onclick="location.href='dashboard.html'" class="btn btn-secondary"><i class="fas fa-home"></i> ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        </div>
    </div>

    <div class="card">
        <div class="table-container">
            <table id="adminTable">
                <thead>
                    <tr>
                        <th width="20%">‡∏ä‡∏∑‡πà‡∏≠ / ‡∏£‡∏´‡∏±‡∏™</th>
                        <th width="25%">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                        <th width="15%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th width="8%">‡∏ä‡∏°.</th>
                        <th width="10%">‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô</th>
                        <th width="10%">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        <th width="12%">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="7" style="text-align:center; padding: 50px; color:#94a3b8;">
                        <i class="fas fa-circle-notch fa-spin"></i> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...
                    </td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwDYB9-YNqmcRyBPVi3twtY-lTD-V0kPOjSD0AsVjwljno6h8PuIrNSLvqd1PeVR23V/exec";
    const CSV_URL = "https://docs.google.com/spreadsheets/d/18ZRn1Uv3UOw8Wwmhw85JDCA5_Tz_KYFqB3VPYq7EwVU/export?format=csv&gid=154014344";

    let allLogs = [];
    
    // --- MAIN ---
    window.onload = function() {
        if(!localStorage.getItem('volunteerSession')) window.location.href = 'index.html';

        // 1. Instant Cache Load
        loadFromCache();

        // 2. Network Load
        forceRefresh(true);

        // 3. Auto Sync
        setInterval(() => loadAPI(true), 4000);
    };

    function loadFromCache() {
        const cached = localStorage.getItem('adminData');
        if (cached) {
            allLogs = JSON.parse(cached);
            renderTable();
            updateStatus('Cached View', 'cache');
        }
    }

    function saveToCache(data) {
        localStorage.setItem('adminData', JSON.stringify(data));
    }

    async function forceRefresh(silent = false) {
        const btn = document.getElementById('btnRefresh');
        const icon = document.getElementById('iconRefresh');

        if(!silent) {
            icon.classList.add('fa-spin');
            btn.disabled = true;
        }

        const pCSV = new Promise(resolve => {
            Papa.parse(CSV_URL + "&t=" + Date.now(), { 
                download: true, header: true, skipEmptyLines: true,
                complete: (res) => { 
                    if(res.data && res.data.length > 0) resolve({src:'csv', data:res.data}); 
                },
                error: () => resolve(null)
            });
        });

        const pAPI = fetch(`${API_URL}?action=getAllActivities&t=${Date.now()}`)
            .then(r => r.json())
            .then(d => d.status === 'success' ? {src:'api', data:d.activities} : null)
            .catch(() => null);

        const winner = await Promise.race([pCSV, pAPI]);

        if (winner) {
            processData(winner.data);
            if(!silent) showToast();
        }

        if(!silent) {
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }

        Promise.all([pCSV, pAPI]).then(results => {
            results.forEach(res => { if(res) processData(res.data); });
        });
    }

    async function loadAPI(background = false) {
        try {
            const res = await fetch(`${API_URL}?action=getAllActivities&t=${Date.now()}`);
            const data = await res.json();
            if(data.status === 'success') {
                processData(data.activities);
                if(!background) document.querySelector('#loader .bar').style.width = '100%';
            }
        } catch(e) {}
    }

    function processData(rawData) {
        const mapped = rawData.map(r => ({
            id: r.id || r.ID,
            userId: r.userId || '',
            name: r.userName || r['‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•'] || r.name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
            studentId: r.studentId || '',
            activity: r.activityName || r['‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°'] || r.activity || '',
            place: r.place || r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà'] || '',
            hours: parseFloat(r.hours || r['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á'] || 0),
            date: r.date || r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || '',
            status: r.status || r['‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'] || 'pending',
            img: r.imageUrl || r['‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô'] || r.image || '',
            ts: r.timestamp || ''
        })).filter(x => x.id);

        if(JSON.stringify(mapped) === JSON.stringify(allLogs)) {
            updateStatus('Live Sync Active', 'active');
            return;
        }

        allLogs = mapped;
        allLogs.sort((a,b) => new Date(b.ts || b.date) - new Date(a.ts || a.date));
        
        saveToCache(allLogs);
        renderTable();
        updateStatus('Live Sync Active', 'active');
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        if(!allLogs.length) return tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>`;

        let html = '';
        allLogs.forEach(d => {
            const badgeClass = d.status === 'approved' ? 'approved' : (d.status === 'rejected' ? 'rejected' : 'pending');
            const badgeText = d.status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : (d.status === 'rejected' ? '‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò' : '‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö');
            const bgRow = d.status === 'pending' ? 'background:#fffbeb;' : '';

            // ‡πÉ‡∏ä‡πâ div ‡∏Ñ‡∏£‡∏≠‡∏ö activity ‡πÅ‡∏•‡∏∞ place ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏î‡πâ‡∏ß‡∏¢ ... (Ellipsis)
            html += `
            <tr style="${bgRow}">
                <td data-label="‡∏ä‡∏∑‡πà‡∏≠">
                    <div style="font-weight:600; color:#1e293b;">${d.name}</div>
                    <div style="font-size:12px; color:#64748b;">${d.studentId || '-'}</div>
                    <div style="font-size:12px; color:#94a3b8;">${d.date}</div>
                </td>
                <td data-label="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
                    <div style="max-width: 250px; overflow: hidden; text-overflow: ellipsis;" title="${d.activity}">
                        ${d.activity}
                    </div>
                </td>
                <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà">
                    <div style="max-width: 150px; overflow: hidden; text-overflow: ellipsis;" title="${d.place}">
                        ${d.place}
                    </div>
                </td>
                <td data-label="‡∏ä‡∏°." style="font-weight:bold; color:#2563eb;">${d.hours}</td>
                <td data-label="‡∏´‡∏•‡∏±‡∏Å‡∏ê‡∏≤‡∏ô">
                    ${d.img ? `<a href="${d.img}" target="_blank" style="color:#2563eb; text-decoration:none;"><i class="fas fa-image"></i> ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</a>` : '-'}
                </td>
                <td data-label="‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞"><span class="badge ${badgeClass}">${badgeText}</span></td>
                <td data-label="‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£">
                    <div style="display:flex; justify-content: flex-end; gap:4px;">
                        ${d.status !== 'approved' ? 
                        `<button class="action-btn btn-check" onclick="doAction('approve', '${d.id}', ${d.hours}, '${d.userId}')" title="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥"><i class="fas fa-check"></i></button>` : ''}
                        <button class="action-btn btn-edit" onclick="editItem('${d.id}')" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"><i class="fas fa-pen"></i></button>
                        <button class="action-btn btn-cross" onclick="doAction('reject', '${d.id}')" title="‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò"><i class="fas fa-times"></i></button>
                        <button class="action-btn btn-trash" onclick="doAction('delete', '${d.id}')" title="‡∏•‡∏ö"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    async function doAction(type, id, val1, val2) {
        let conf;
        if(type === 'approve') conf = await Swal.fire({ title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥?', text: `${val1} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`, icon: 'question', showCancelButton: true, confirmButtonColor: '#22c55e', confirmButtonText: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' });
        else if(type === 'delete') conf = await Swal.fire({ title: '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#64748b', confirmButtonText: '‡∏•‡∏ö' });
        else if(type === 'reject') {
            const { value: reason } = await Swal.fire({ title: '‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', input: 'text', showCancelButton: true, confirmButtonColor: '#ef4444' });
            if(reason) conf = { isConfirmed: true, value: reason };
        }

        if(conf && conf.isConfirmed) {
            const idx = allLogs.findIndex(x => x.id == id);
            if(idx > -1) {
                if(type === 'delete') allLogs.splice(idx, 1);
                else allLogs[idx].status = type === 'approve' ? 'approved' : 'rejected';
                saveToCache(allLogs);
                renderTable();
            }

            const payload = { action: type === 'delete' ? 'deleteActivity' : 'updateActivity', id: id, status: type === 'approve' ? 'approved' : 'rejected', note: conf.value || '' };
            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });

            if(type === 'approve') {
                fetch(`${API_URL}?action=getUser&uid=${val2}`)
                .then(r=>r.json()).then(res => {
                    if(res.status==='success') fetch(API_URL, { method:'POST', body:JSON.stringify({ action:'updateUser', uid:val2, approvedHours: (res.user.approvedHours||0)+val1, totalHours: res.user.totalHours }) });
                });
            }
        }
    }

    async function editItem(id) {
        const item = allLogs.find(x => x.id == id);
        const { value: f } = await Swal.fire({
            title: '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
            html: `<input id="e-n" class="swal2-input" value="${item.activity}"><input id="e-p" class="swal2-input" value="${item.place}"><input id="e-h" type="number" class="swal2-input" value="${item.hours}">`,
            showCancelButton: true, preConfirm: () => ({ activityName: document.getElementById('e-n').value, place: document.getElementById('e-p').value, hours: document.getElementById('e-h').value })
        });
        if(f) {
            item.activity = f.activityName; item.place = f.place; item.hours = f.hours;
            saveToCache(allLogs);
            renderTable();
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateActivity', id: id, ...f }) });
        }
    }

    async function manualAdd() {
        const { value: s } = await Swal.fire({ title: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', input: 'text', inputLabel: '‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', showCancelButton: true });
        if(!s) return;
        
        Swal.showLoading();
        const res = await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'checkStudentId', studentId:s})}).then(r=>r.json());
        Swal.close();
        if(!res.found) return Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô','','error');

        const { value: f } = await Swal.fire({
            title: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ: ${res.user.name}`,
            html: `<input id="m-n" class="swal2-input" placeholder="‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°"><input id="m-h" type="number" class="swal2-input" placeholder="‡∏ä‡∏°."><input id="m-d" type="date" class="swal2-input">`,
            showCancelButton: true, preConfirm:()=>({ activityName: document.getElementById('m-n').value, hours: document.getElementById('m-h').value, date: document.getElementById('m-d').value })
        });

        if(f) {
            await fetch(API_URL, { method:'POST', body:JSON.stringify({
                action:'createActivity', userId:res.user.uid, userName:res.user.name, studentId:res.user.studentId,
                activityName:f.activityName, place:'-', hours:parseFloat(f.hours), date:f.date, time:'00:00',
                personInCharge:'Admin', imageUrl:'', status:'approved'
            })});
            fetch(API_URL, { method:'POST', body:JSON.stringify({ action:'updateUser', uid:res.user.uid, approvedHours:(res.user.approvedHours||0)+parseFloat(f.hours), totalHours:(res.user.totalHours||0)+parseFloat(f.hours) })});
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','','success');
            forceRefresh();
        }
    }

    function updateStatus(text, type) {
        const dot = document.getElementById('liveDot');
        const txt = document.getElementById('liveText');
        dot.className = 'dot ' + type;
        txt.innerText = text;
        txt.style.color = type === 'active' ? '#166534' : '#b45309';
    }

    function showToast() {
        Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 }).fire({ icon: 'success', title: '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏•‡πâ‡∏ß' });
    }
</script>
</body>
</html>