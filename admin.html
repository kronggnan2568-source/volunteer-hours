<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Super Fast</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;
            --primary-light: #eff6ff;
            --border-color: #cbd5e1;
            --text-head: #1e293b;
            --text-body: #475569;
            --bg: #f1f5f9;
        }

        body { font-family: 'Sarabun', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text-body); }
        .container { max-width: 100%; margin: 0 auto; padding: 0 10px; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .title-group h2 { margin: 0; color: #0f172a; font-size: 20px; }
        .status-badge { display: inline-flex; align-items: center; font-size: 12px; padding: 4px 10px; border-radius: 20px; background: #e2e8f0; color: #64748b; margin-top: 5px; }
        .dot { width: 8px; height: 8px; background: #ef4444; border-radius: 50%; margin-right: 6px; transition: 0.3s; }
        .dot.active { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .dot.cache { background: #f59e0b; box-shadow: 0 0 8px #f59e0b; }

        /* Card Design */
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); overflow: hidden; border: 1px solid #e2e8f0; }

        /* Fixed Layout Table */
        .table-container { 
            width: 100%; 
            overflow-x: hidden;
        }
        
        table { 
            width: 100%; 
            table-layout: fixed;
            border-collapse: collapse; 
        }
        
        thead { background: #f8fafc; }
        
        th { 
            padding: 12px 8px; 
            text-align: left; 
            font-weight: 600; 
            color: var(--text-head); 
            border-bottom: 2px solid var(--border-color);
            white-space: nowrap;
            font-size: 13px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        td { 
            padding: 12px 8px; 
            border-bottom: 1px solid var(--border-color);
            vertical-align: middle;
            font-size: 13px;
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis;
        }

        tr:hover td { background-color: #f8fafc; cursor: default; }

        /* Badges */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: capitalize; display: inline-block; min-width: 60px; text-align: center;}
        .badge.approved { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
        .badge.rejected { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
        .badge.pending { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; }

        /* Buttons */
        .btn { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 500; transition: 0.2s; font-family: 'Sarabun'; display: inline-flex; align-items: center; gap: 6px; font-size: 13px; }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2); }
        .btn-secondary { background: white; border: 1px solid var(--border-color); color: var(--text-body); }
        .btn:disabled { opacity: 0.7; cursor: not-allowed; }

        /* Download Button */
        .btn-img { 
            background: #eff6ff; color: #2563eb; border: 1px solid #bfdbfe; 
            padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; 
            display: inline-flex; align-items: center; gap: 5px; font-weight: 500;
            transition: 0.2s; font-family: 'Sarabun';
        }
        .btn-img:hover { background: #dbeafe; transform: translateY(-1px); }
        .btn-img:active { transform: translateY(0); }

        /* Action Buttons */
        .action-btn { width: 26px; height: 26px; border-radius: 4px; border: none; display: inline-flex; align-items: center; justify-content: center; margin: 0 1px; cursor: pointer; color: white; transition: 0.2s; font-size: 11px; }
        .action-btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-check { background: #22c55e; }
        .btn-edit { background: #f59e0b; }
        .btn-cross { background: #ef4444; }
        .btn-trash { background: #64748b; }

        /* Loading Overlay */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 3px; background: transparent; z-index: 9999; }
        #loader .bar { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }

        /* Mobile Responsive - Card View */
        @media (max-width: 768px) {
            thead { display: none; }
            table { table-layout: auto; display: block; }
            tbody { display: block; }
            tr { display: block; border: 1px solid var(--border-color); margin-bottom: 10px; border-radius: 8px; padding: 12px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
            td { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border: none; border-bottom: 1px dashed #e2e8f0; white-space: normal; overflow: visible; text-overflow: clip; }
            td:last-child { border-bottom: none; padding-top: 12px; }
            td::before { content: attr(data-label); font-weight: 600; color: #64748b; font-size: 12px; margin-right: 10px; min-width: 60px; }
            
            .header { flex-direction: column; align-items: flex-start; }
            .header > div { display: flex; width: 100%; gap: 5px; }
            .btn { flex: 1; justify-content: center; }
        }
    </style>
</head>
<body>

<div id="loader"><div class="bar"></div></div>

<div class="container">
    <div class="header">
        <div class="title-group">
            <h2><i class="fas fa-user-shield"></i> Admin Dashboard</h2> 
            <div class="status-badge"><span class="dot" id="liveDot"></span> <span id="liveText">Connecting...</span></div>
        </div>
        <div>
            <button onclick="forceRefresh()" class="btn btn-secondary" id="btnRefresh">
                <i class="fas fa-sync" id="iconRefresh"></i>
            </button>
            <button onclick="manualAdd()" class="btn btn-primary"><i class="fas fa-plus"></i> เพิ่ม</button>
            <button onclick="location.href='index.html'" class="btn btn-secondary"><i class="fas fa-home"></i></button>
        </div>
    </div>

    <div class="card">
        <div class="table-container">
            <table id="adminTable">
                <thead>
                    <tr>
                        <th style="width: 18%;">ชื่อ/รหัส</th>
                        <th style="width: 20%;">กิจกรรม</th>
                        <th style="width: 15%;">สถานที่</th>
                        <th style="width: 8%;">ชม.</th>
                        <th style="width: 16%;">หลักฐาน</th>
                        <th style="width: 10%;">สถานะ</th>
                        <th style="width: 13%;">จัดการ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="7" style="text-align:center; padding: 50px; color:#94a3b8;">
                        <i class="fas fa-circle-notch fa-spin"></i> กำลังโหลด...
                    </td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // --- CONFIG ---
    const API_URL = "https://script.google.com/macros/s/AKfycbwDYB9-YNqmcRyBPVi3twtY-lTD-V0kPOjSD0AsVjwljno6h8PuIrNSLvqd1PeVR23V/exec";
    const CSV_URL = "https://docs.google.com/spreadsheets/d/18ZRn1Uv3UOw8Wwmhw85JDCA5_Tz_KYFqB3VPYq7EwVU/export?format=csv&gid=154014344";

    let allLogs = [];
    
    // --- MAIN ---
    window.onload = function() {
        if(!localStorage.getItem('volunteerSession')) window.location.href = 'index.html';
        loadFromCache();
        forceRefresh(true);
        setInterval(() => loadAPI(true), 4000);
    };

    function loadFromCache() {
        const cached = localStorage.getItem('adminData');
        if (cached) {
            allLogs = JSON.parse(cached);
            renderTable();
            updateStatus('Cached View', 'cache');
        }
    }

    function saveToCache(data) {
        localStorage.setItem('adminData', JSON.stringify(data));
    }

    async function forceRefresh(silent = false) {
        const btn = document.getElementById('btnRefresh');
        const icon = document.getElementById('iconRefresh');

        if(!silent) {
            icon.classList.add('fa-spin');
            btn.disabled = true;
        }

        const pCSV = new Promise(resolve => {
            Papa.parse(CSV_URL + "&t=" + Date.now(), { 
                download: true, header: true, skipEmptyLines: true,
                complete: (res) => { 
                    if(res.data && res.data.length > 0) resolve({src:'csv', data:res.data}); 
                },
                error: () => resolve(null)
            });
        });

        const pAPI = fetch(`${API_URL}?action=getAllActivities&t=${Date.now()}`)
            .then(r => r.json())
            .then(d => d.status === 'success' ? {src:'api', data:d.activities} : null)
            .catch(() => null);

        const winner = await Promise.race([pCSV, pAPI]);

        if (winner) {
            processData(winner.data);
            if(!silent) showToast();
        }

        if(!silent) {
            icon.classList.remove('fa-spin');
            btn.disabled = false;
        }

        Promise.all([pCSV, pAPI]).then(results => {
            results.forEach(res => { if(res) processData(res.data); });
        });
    }

    async function loadAPI(background = false) {
        try {
            const res = await fetch(`${API_URL}?action=getAllActivities&t=${Date.now()}`);
            const data = await res.json();
            if(data.status === 'success') {
                processData(data.activities);
                if(!background) document.querySelector('#loader .bar').style.width = '100%';
            }
        } catch(e) {}
    }

    function processData(rawData) {
        const mapped = rawData.map(r => ({
            id: r.id || r.ID,
            userId: r.userId || '',
            name: r.userName || r['ชื่อ-สกุล'] || r.name || 'ไม่ระบุ',
            studentId: r.studentId || '',
            activity: r.activityName || r['ชื่อกิจกรรม'] || r.activity || '',
            place: r.place || r['สถานที่'] || '',
            hours: parseFloat(r.hours || r['จำนวนชั่วโมง'] || 0),
            date: r.date || r['วันที่'] || '',
            status: r.status || r['สถานะ'] || 'pending',
            img: r.imageUrl || r['หลักฐาน'] || r.image || '',
            ts: r.timestamp || ''
        })).filter(x => x.id);

        if(JSON.stringify(mapped) === JSON.stringify(allLogs)) {
            updateStatus('Live Sync Active', 'active');
            return;
        }

        allLogs = mapped;
        allLogs.sort((a,b) => new Date(b.ts || b.date) - new Date(a.ts || a.date));
        saveToCache(allLogs);
        renderTable();
        updateStatus('Live Sync Active', 'active');
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        if(!allLogs.length) return tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px;">ไม่พบข้อมูล</td></tr>`;

        let html = '';
        allLogs.forEach(d => {
            const badgeClass = d.status === 'approved' ? 'approved' : (d.status === 'rejected' ? 'rejected' : 'pending');
            const badgeText = d.status === 'approved' ? 'อนุมัติ' : (d.status === 'rejected' ? 'ปฏิเสธ' : 'รอ');
            const bgRow = d.status === 'pending' ? 'background:#fffbeb;' : '';

            // Image Button - Download Only
            let imgBtns = '<span style="color:#cbd5e1; font-size:11px;">-</span>';
            if(d.img) {
                imgBtns = `
                <button onclick="downloadImage('${d.img}', 'evidence-${d.studentId}-${d.id}')" class="btn-img" title="ดาวน์โหลด" style="display:inline-flex;">
                    <i class="fas fa-download"></i> ดาวน์โหลด
                </button>`;
            }

            html += `
            <tr style="${bgRow}">
                <td data-label="ชื่อ">
                    <div style="font-weight:600; color:#1e293b;">${d.name}</div>
                    <div style="font-size:11px; color:#64748b;">${d.studentId || '-'}</div>
                </td>
                <td data-label="กิจกรรม" title="${d.activity}">
                    ${d.activity}
                </td>
                <td data-label="สถานที่" title="${d.place}">
                    ${d.place}
                </td>
                <td data-label="ชม." style="font-weight:bold; color:#2563eb;">${d.hours}</td>
                <td data-label="หลักฐาน">
                    ${imgBtns}
                </td>
                <td data-label="สถานะ"><span class="badge ${badgeClass}">${badgeText}</span></td>
                <td data-label="จัดการ">
                    <div style="display:flex; gap:2px; justify-content:flex-start;">
                        ${d.status !== 'approved' ? 
                        `<button class="action-btn btn-check" onclick="doAction('approve', '${d.id}', ${d.hours}, '${d.userId}')" title="อนุมัติ"><i class="fas fa-check"></i></button>` : ''}
                        <button class="action-btn btn-edit" onclick="editItem('${d.id}')" title="แก้ไข"><i class="fas fa-pen"></i></button>
                        <button class="action-btn btn-cross" onclick="doAction('reject', '${d.id}')" title="ปฏิเสธ"><i class="fas fa-times"></i></button>
                        <button class="action-btn btn-trash" onclick="doAction('delete', '${d.id}')" title="ลบ"><i class="fas fa-trash"></i></button>
                    </div>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // --- Image Download Function (Enhanced for Google Drive) ---
    async function downloadImage(url, filename) {
        // Extract Google Drive file ID
        let fileId = null;
        
        if (url.includes('drive.google.com')) {
            // Match different Google Drive URL formats
            const patterns = [
                /\/d\/([a-zA-Z0-9_-]+)/,  // /d/FILE_ID/
                /id=([a-zA-Z0-9_-]+)/,     // ?id=FILE_ID
                /\/file\/d\/([a-zA-Z0-9_-]+)/ // /file/d/FILE_ID
            ];
            
            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match && match[1]) {
                    fileId = match[1];
                    break;
                }
            }
        }

        // If it's a Google Drive file, use direct download link
        if (fileId) {
            const directUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
            
            // Show loading toast
            Swal.fire({
                title: 'กำลังดาวน์โหลด...',
                text: 'กรุณารอสักครู่',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                // Try to fetch and download as blob
                const response = await fetch(directUrl, { 
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const blobUrl = window.URL.createObjectURL(blob);
                    
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = filename + '.jpg';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(blobUrl);
                    
                    Swal.close();
                    Swal.fire({ icon: 'success', title: 'ดาวน์โหลดสำเร็จ', timer: 1500, showConfirmButton: false });
                    return;
                }
            } catch (error) {
                console.warn('Fetch failed, using fallback method:', error);
            }

            // Fallback: Open in new window with download parameter
            Swal.close();
            window.open(directUrl, '_blank');
            Swal.fire({ 
                icon: 'info', 
                title: 'เปิดหน้าดาวน์โหลด', 
                text: 'หากไม่ดาวน์โหลดอัตโนมัติ คลิกขวา > Save Image As',
                timer: 3000 
            });
        } else {
            // For non-Google Drive URLs
            const link = document.createElement('a');
            link.href = url;
            link.download = filename + '.jpg';
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }

    async function doAction(type, id, val1, val2) {
        let conf;
        if(type === 'approve') conf = await Swal.fire({ title: 'ยืนยันอนุมัติ?', text: `${val1} ชั่วโมง`, icon: 'question', showCancelButton: true, confirmButtonColor: '#22c55e', confirmButtonText: 'อนุมัติ' });
        else if(type === 'delete') conf = await Swal.fire({ title: 'ลบรายการ?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#64748b', confirmButtonText: 'ลบ' });
        else if(type === 'reject') {
            const { value: reason } = await Swal.fire({ title: 'ระบุเหตุผล', input: 'text', showCancelButton: true, confirmButtonColor: '#ef4444' });
            if(reason) conf = { isConfirmed: true, value: reason };
        }

        if(conf && conf.isConfirmed) {
            const idx = allLogs.findIndex(x => x.id == id);
            if(idx > -1) {
                if(type === 'delete') allLogs.splice(idx, 1);
                else allLogs[idx].status = type === 'approve' ? 'approved' : 'rejected';
                saveToCache(allLogs);
                renderTable();
            }

            const payload = { action: type === 'delete' ? 'deleteActivity' : 'updateActivity', id: id, status: type === 'approve' ? 'approved' : 'rejected', note: conf.value || '' };
            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) });

            if(type === 'approve') {
                fetch(`${API_URL}?action=getUser&uid=${val2}`)
                .then(r=>r.json()).then(res => {
                    if(res.status==='success') fetch(API_URL, { method:'POST', body:JSON.stringify({ action:'updateUser', uid:val2, approvedHours: (res.user.approvedHours||0)+val1, totalHours: res.user.totalHours }) });
                });
            }
        }
    }

    async function editItem(id) {
        const item = allLogs.find(x => x.id == id);
        const { value: f } = await Swal.fire({
            title: 'แก้ไขข้อมูล',
            html: `<input id="e-n" class="swal2-input" value="${item.activity}"><input id="e-p" class="swal2-input" value="${item.place}"><input id="e-h" type="number" class="swal2-input" value="${item.hours}">`,
            showCancelButton: true, preConfirm: () => ({ activityName: document.getElementById('e-n').value, place: document.getElementById('e-p').value, hours: document.getElementById('e-h').value })
        });
        if(f) {
            item.activity = f.activityName; item.place = f.place; item.hours = f.hours;
            saveToCache(allLogs);
            renderTable();
            fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateActivity', id: id, ...f }) });
        }
    }

    async function manualAdd() {
        const { value: s } = await Swal.fire({ title: 'เพิ่มกิจกรรม', input: 'text', inputLabel: 'รหัสนักเรียน', showCancelButton: true });
        if(!s) return;
        
        Swal.showLoading();
        const res = await fetch(API_URL, { method:'POST', body:JSON.stringify({action:'checkStudentId', studentId:s})}).then(r=>r.json());
        Swal.close();
        if(!res.found) return Swal.fire('ไม่พบนักเรียน','','error');

        const { value: f } = await Swal.fire({
            title: `เพิ่มให้: ${res.user.name}`,
            html: `<input id="m-n" class="swal2-input" placeholder="กิจกรรม"><input id="m-h" type="number" class="swal2-input" placeholder="ชม."><input id="m-d" type="date" class="swal2-input">`,
            showCancelButton: true, preConfirm:()=>({ activityName: document.getElementById('m-n').value, hours: document.getElementById('m-h').value, date: document.getElementById('m-d').value })
        });

        if(f) {
            await fetch(API_URL, { method:'POST', body:JSON.stringify({
                action:'createActivity', userId:res.user.uid, userName:res.user.name, studentId:res.user.studentId,
                activityName:f.activityName, place:'-', hours:parseFloat(f.hours), date:f.date, time:'00:00',
                personInCharge:'Admin', imageUrl:'', status:'approved'
            })});
            fetch(API_URL, { method:'POST', body:JSON.stringify({ action:'updateUser', uid:res.user.uid, approvedHours:(res.user.approvedHours||0)+parseFloat(f.hours), totalHours:(res.user.totalHours||0)+parseFloat(f.hours) })});
            Swal.fire('สำเร็จ','','success');
            forceRefresh();
        }
    }

    function updateStatus(text, type) {
        const dot = document.getElementById('liveDot');
        const txt = document.getElementById('liveText');
        dot.className = 'dot ' + type;
        txt.innerText = text;
        txt.style.color = type === 'active' ? '#166534' : '#b45309';
    }

    function showToast() {
        Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 }).fire({ icon: 'success', title: 'อัปเดตแล้ว' });
    }
</script>
</body>
</html>